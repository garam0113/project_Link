<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  						
<mapper namespace="ClubPostMapper">



	<resultMap	id="clubPostSelectMap" type="com.link.service.domain.ClubPost">
		<result property="clubNo" 					column="club_no" 					jdbcType="NUMERIC"/>
		<result property="clubPostNo"				column="club_post_no" 				jdbcType="NUMERIC"/>
		<result property="user.userId" 				column="user_id" 					jdbcType="VARCHAR"/>
		<result property="clubPostTitle" 			column="club_post_title" 			jdbcType="VARCHAR"/>
		<result property="clubPostContent" 			column="club_post_content" 			jdbcType="VARCHAR"/>
		<result property="clubPostVideo1" 			column="club_post_video1" 			jdbcType="VARCHAR"/>
		<result property="clubPostVideo2" 			column="club_post_video2" 			jdbcType="VARCHAR"/>
		<result property="clubPostVideo3" 			column="club_post_video3" 			jdbcType="VARCHAR"/>
		<result property="clubPostRegDate" 			column="club_post_reg_date" 		jdbcType="VARCHAR"/>
		<result property="clubPostUpdateDate" 		column="club_post_update_date" 		jdbcType="VARCHAR"/>
		<result property="clubPostHeartCount" 		column="club_post_heart_count" 		jdbcType="NUMERIC"/>
		<result property="clubPostCommentCount" 	column="club_post_comment_count" 	jdbcType="NUMERIC"/>
		<result property="image1" 					column="image1" 					jdbcType="VARCHAR"/>
		<result property="image2" 					column="image2" 					jdbcType="VARCHAR"/>
		<result property="image3" 					column="image3" 					jdbcType="VARCHAR"/>
		<result property="image4" 					column="image4" 					jdbcType="VARCHAR"/>
		<result property="image5" 					column="image5" 					jdbcType="VARCHAR"/>
		<result property="image6" 					column="image6" 					jdbcType="VARCHAR"/>
		<result property="image7" 					column="image7" 					jdbcType="VARCHAR"/>
		<result property="image8" 					column="image8" 					jdbcType="VARCHAR"/>
		<result property="image9" 					column="image9" 					jdbcType="VARCHAR"/>
		<result property="image10" 					column="image10" 					jdbcType="VARCHAR"/>
	</resultMap>
	
	
	
	<sql id="select-list">
		SELECT CLUB_NO, CLUB_POST_NO, IMAGE1, CLUB_POST_TITLE, USER_ID, CLUB_POST_HEART_COUNT
		FROM CLUB_POST
		WHERE CLUB_NO = 
		<choose>
			<when test="clubPost.clubNo != null and clubPost.clubNo != '' and clubPost.clubNo != 0">#{ clubPost.clubNo }</when>
			<when test="clubPost.clubNo != null and clubPost.clubNo != '' and clubPost.clubNo != 0 and search.order == 3">#{ clubPost.clubNo } AND USER_ID = #{ clubPost.user.userId }</when>
		<otherwise>
			( SELECT V2.CLUB_NO
				FROM ( SELECT ROWNUM, V1.*
						FROM ( SELECT *
								FROM CLUB_USER
								WHERE USER_ID = #{ clubPost.user.userId } AND JOIN_REG_DATE IS NOT NULL
								ORDER BY JOIN_REG_DATE DESC ) V1
						WHERE ROWNUM = 1 ) V2 )
		</otherwise>
		</choose>
		AND REPORT_CONDITION = '0' AND DELETE_CONDITION = '0'
		ORDER BY
		<choose>
			<when test="search.order == 2">CLUB_POST_HEART_COUNT DESC, CLUB_POST_REG_DATE DESC</when>
			<when test="search.order == 1">CLUB_POST_REG_DATE DESC</when>
		<otherwise>
			CLUB_POST_REG_DATE DESC
		</otherwise>
		</choose>
	</sql>



	<!-- 모임게시물 등록 -->
	<insert id="addClubPost" parameterType="com.link.service.domain.ClubPost">
	 	INSERT INTO CLUB_POST (CLUB_POST_NO, CLUB_NO, USER_ID, CLUB_POST_TITLE, CLUB_POST_CONTENT, CLUB_POST_VIDEO1, CLUB_POST_VIDEO2, 
		CLUB_POST_VIDEO3, CLUB_POST_REG_DATE, CLUB_POST_UPDATE_DATE, CLUB_POST_HEART_COUNT, CLUB_POST_COMMENT_COUNT, REPORT_CONDITION,
		DELETE_CONDITION, IMAGE1, IMAGE2, IMAGE3, IMAGE4, IMAGE5, IMAGE6, IMAGE7, IMAGE8, IMAGE9, IMAGE10)
		VALUES (seq_club_post_no.NEXTVAL, #{clubNo}, #{user.userId}, #{clubPostTitle}, #{clubPostContent:VARCHAR},
		#{clubPostVideo1:VARCHAR}, #{clubPostVideo2:VARCHAR}, #{clubPostVideo3:VARCHAR}, sysdate, null, 0, 0, '0', '0',
		#{image1}, #{image2:VARCHAR}, #{image3:VARCHAR}, #{image4:VARCHAR}, #{image5:VARCHAR}, #{image6:VARCHAR},
		#{image7:VARCHAR}, #{image8:VARCHAR}, #{image9:VARCHAR}, #{image10:VARCHAR})
	</insert>
	
	
	
	<!-- 모임게시물 탭 클릭시 => 최근 가입한 모임의 모임게시물리스트 가져온다 -->
	<select id="getClubPostList" parameterType="map" resultMap="clubPostSelectMap">
		SELECT V3.*
		FROM ( SELECT ROW_NUMBER() OVER(ORDER BY CLUB_POST_NO DESC) AS R, V2.*
				FROM (
						<include refid="select-list"></include>
					 ) V2
			 ) V3
		WHERE R BETWEEN ((#{ search.currentPage }-1)*#{ search.pageSize }+1) AND #{ search.currentPage }*#{ search.pageSize }
	</select>
	
	
	
	<!-- 모임게시물 탭 클릭시 => 최근 가입한 모임의 모임게시물리스트의 개수 가져온다 -->
	<select id="getClubPostListCount" parameterType="map" resultType="int" >
		SELECT COUNT(*)
		FROM ( SELECT ROW_NUMBER() OVER(ORDER BY CLUB_POST_NO DESC) AS R, V2.*
				FROM (
						<include refid="select-list"></include>
					 ) V2
			 ) V3
		WHERE R BETWEEN ((#{ search.currentPage }-1)*#{ search.pageSize }+1) AND #{ search.currentPage }*#{ search.pageSize }
	</select>
	

	
	
	
	
	
	<!-- 모임게시물 상세보기 -->
	<select id="getClubPost" parameterType="clubPost" resultMap="clubPostSelectMap">
		SELECT CLUB_POST_NO, CLUB_NO, USER_ID, CLUB_POST_TITLE, CLUB_POST_CONTENT, CLUB_POST_VIDEO1, CLUB_POST_VIDEO2, 
		CLUB_POST_VIDEO3, CLUB_POST_REG_DATE, CLUB_POST_UPDATE_DATE, CLUB_POST_HEART_COUNT, CLUB_POST_COMMENT_COUNT, IMAGE1,
		IMAGE2, IMAGE3, IMAGE4, IMAGE5, IMAGE6, IMAGE7, IMAGE8, IMAGE9, IMAGE10
		FROM CLUB_POST
		WHERE CLUB_POST_NO = #{ clubPostNo }
	</select>
	
	
	
	<!-- 수정하는 모임게시물 -->
	<update id="updateClubPost" parameterType="map">
		UPDATE CLUB_POST
		SET
		<choose>
			<when test="clubPost.heartCondition == 1">CLUB_POST_HEART_COUNT = CLUB_POST_HEART_COUNT + 1</when>
			<when test="clubPost.heartCondition == -1">CLUB_POST_HEART_COUNT = CLUB_POST_HEART_COUNT - 1</when>
			<when test="clubPost.clubPostCommentNo != 0">CLUB_POST_COMMENT_COUNT= CLUB_POST_COMMENT_COUNT + 1</when>
			<when test="reportCondition == 1">REPORT_CONDITION = 1</when>
			<otherwise>
				CLUB_POST_TITLE = #{ clubPost.clubPostTitle }, CLUB_POST_CONTENT = #{ clubPost.clubPostContent }, CLUB_POST_VIDEO1 = #{ clubPost.clubPostVideo1:VARCHAR }, CLUB_POST_VIDEO2 = #{ clubPost.clubPostVideo2:VARCHAR },
				CLUB_POST_VIDEO3 = #{ clubPost.clubPostVideo3:VARCHAR }, CLUB_POST_UPDATE_DATE = sysdate, IMAGE1 = #{ clubPost.image1:VARCHAR }, IMAGE2 = #{ clubPost.image2:VARCHAR }, IMAGE3 = #{ clubPost.image3:VARCHAR },
				IMAGE4 = #{ clubPost.image4:VARCHAR }, IMAGE5 = #{ clubPost.image5:VARCHAR }, IMAGE6 = #{ clubPost.image6:VARCHAR }, IMAGE7 = #{ clubPost.image7:VARCHAR }, IMAGE8 = #{ clubPost.image8:VARCHAR },
				IMAGE9 = #{ clubPost.image9:VARCHAR }, IMAGE10 = #{ clubPost.image10:VARCHAR }
			</otherwise>
		</choose>
		WHERE CLUB_POST_NO = #{ clubPost.clubPostNo }
	</update>
	
	
	
	<!-- 삭제하는 모임게시물 -->
	<update id="deleteClubPost" parameterType="clubPost">
		UPDATE CLUB_POST SET DELETE_CONDITION = '1' WHERE CLUB_POST_NO = #{ clubPostNo }
	</update>
	
	
	
	<select id="getCurrval" parameterType="clubPost" resultType="clubPost">
		SELECT ROWNUM, seq_club_post_no.currval AS clubPostNo FROM CLUB_POST WHERE ROWNUM = 1
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- 마이홈피 - 내가 작성한 모임게시물 리스트 -->
	<select id="getClubPostListMyHome" parameterType="string" resultMap="clubPostSelectMap">
		SELECT CLUB_POST_NO, IMAGE1, CLUB_POST_TITLE, USER_ID, CLUB_POST_HEART_COUNT
		FROM CLUB_POST
		WHERE USER_ID = #{ userId } AND REPORT_CONDITION = '0' AND DELETE_CONDITION = '0'
		ORDER BY CLUB_POST_REG_DATE DESC
	</select>
	
	
	
	<!-- 마이홈피 - 내가 작성한 모임게시물 리스트 개수 -->
	<select id="getClubPostListMyHomeCount" parameterType="string" resultType="int">
		SELECT COUNT(*) FROM CLUB_POST WHERE USER_ID = #{ userId } AND REPORT_CONDITION = '0' AND DELETE_CONDITION = '0'
	</select>
	
	
	
	<!-- 결제추가 -->
	<insert id="addPay" parameterType="pay">
		INSERT INTO PAY (PAY_NO, USER_ID, CLUB_NO, PAY_PRODUCT, PAY_OPTION, TOTAL_PRICE, PAY_REG_DATE, UPDATE_CLUB_COUNT, UPDATE_CLUB_MEMBER_COUNT, MERCHANT_UID)
		VALUES (seq_pay_no.NEXTVAL, #{ user.userId }, #{ clubNo }, #{ payOption }, #{ payProduct }, #{ totalPrice }, SYSDATE, #{ updateClubCount }, #{ updateClubMemberCount }, #{ merchant_uid })
	</insert>
	
	
	 
</mapper>


